<div id="chartContainer" style="width: 100%; height: 150px;">
    <canvas id="myChart" style="height: 100%; width: 100%;"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let chart;
        let isChartInitialized = false;  // State to check if the chart is initialized
        let updatePending = false;       // Flag to hold if an update is pending

        function createChart() {
            const ctx = document.getElementById('myChart').getContext('2d');
            const chartData = getChartData(); // Load initial data
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false
            };

            // Apply specific options based on chart type
            if (['bar', 'line'].includes(chartType)) {
                chartOptions.scales = {
                    x: {
                        stacked: chartType === 'bar',
                    },
                    y: {
                        beginAtZero: true,
                        stacked: chartType === 'bar'
                    }
                };
            }

            // Create the chart with conditional configuration
            chart = new Chart(ctx, {
                type: chartType,
                data: chartData,
                options: chartOptions
            });

            isChartInitialized = true;  // Set the chart as initialized
            if (updatePending) {
                updateChartData();  // If an update was pending, execute it now
            }
        }

        function updateChartData() {
            if (!isChartInitialized) {
                updatePending = true;  // Set the update as pending if chart isn't ready
                return;
            }
            const newData = getChartData();
            chart.data.labels = newData.labels;
            chart.data.datasets.forEach((dataset, i) => {
                dataset.data = newData.datasets[i].data;
            });
            chart.update();
            updatePending = false;  // Reset the pending update flag
        }

        document.addEventListener('DataTableLoaded', function () {
            if (typeof getChartData !== 'function') {
                console.error('getChartData function is not defined. Ensure it is available in the parent template.');
                return;
            }
            createChart();
        });

        // Update chart on table filter change
        $('#data_table').on('search.dt', function () {
            updateChartData();
        });

        // Update chart after sorting or page changes
        $('#data_table').on('order.dt page.dt', function () {
            updateChartData();
        });
    });
</script>
