<div id="chartContainer" style="width: 100%; height: 150px;">
    <canvas id="myChart" style="height: 100%; width: 100%;"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let chart;
        let isChartInitialized = false;
        let updatePending = false;

        // Generate chart data based on provided parameters
        function generateChartData(data, xvalues, yvalues, groupby = null) {
            const groupedData = {};
            const allXValues = new Set();

            data.forEach(row => {
                const xValue = row[xvalues];
                const yValue = row[yvalues];
                const group = groupby ? row[groupby] : 'default';

                if (!groupedData[group]) {
                    groupedData[group] = {};
                }
                if (!groupedData[group][xValue]) {
                    groupedData[group][xValue] = 0;
                }
                groupedData[group][xValue] += yValue;
                allXValues.add(xValue);
            });

            // Sort x-axis values for consistency
            const sortedXValues = Array.from(allXValues).sort();

            // Handle datasets based on chart type
            if (chartType === 'pie') {
                const pieData = [];
                const labels = [];

                // For pie charts, we donâ€™t need groups; just sum values for each xValue
                sortedXValues.forEach(x => {
                    let total = 0;
                    Object.keys(groupedData).forEach(group => {
                        total += groupedData[group][x] || 0;
                    });
                    labels.push(x);
                    pieData.push(total);
                });

                return {
                    labels: labels,
                    datasets: [{
                        data: pieData,
                        backgroundColor: labels.map(() => randomColor())
                    }]
                };
            } else {
                // For bar and line charts, create datasets per group
                const datasets = Object.keys(groupedData).map(group => {
                    const data = sortedXValues.map(x => ({
                        x: x,
                        y: groupedData[group][x] || 0
                    }));

                    return {
                        label: group,
                        backgroundColor: randomColor(),
                        data: data
                    };
                });

                return { labels: sortedXValues, datasets };
            }
        }

        // Generate random colors for categories
        function randomColor() {
            const r = Math.floor(Math.random() * 256);
            const g = Math.floor(Math.random() * 256);
            const b = Math.floor(Math.random() * 256);
            return `rgba(${r}, ${g}, ${b}, 0.7)`;
        }

        // Fetch and prepare chart data dynamically from the DataTable
        function getChartData() {
            const table = $('#data_table').DataTable();
            const data = table.rows({ filter: 'applied' }).data().toArray();
            return generateChartData(data, xvalues, yvalues, groupby);
        }

        function createChart() {
            const ctx = document.getElementById('myChart').getContext('2d');
            const chartData = getChartData();
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false
            };

            // Apply scales configuration only to applicable chart types
            if (['bar', 'line'].includes(chartType)) {
                chartOptions.scales = {
                    x: { stacked: groupby !== null },
                    y: { beginAtZero: true, stacked: groupby !== null }
                };
            }

            chart = new Chart(ctx, {
                type: chartType,
                data: chartData,
                options: chartOptions
            });

            isChartInitialized = true;
            if (updatePending) {
                updateChartData();
            }
        }

        function updateChartData() {
            if (!isChartInitialized) {
                updatePending = true;
                return;
            }
            const newData = getChartData();
            chart.data.labels = newData.labels;
            chart.data.datasets = newData.datasets;
            chart.update();
            updatePending = false;
        }

        document.addEventListener('DataTableLoaded', function () {
            if (typeof getChartData !== 'function') {
                console.error('getChartData function is not defined. Ensure it is available in the parent template.');
                return;
            }
            createChart();
        });

        $('#data_table').on('search.dt', updateChartData);
        $('#data_table').on('order.dt page.dt', updateChartData);
    });
</script>
